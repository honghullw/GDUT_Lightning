#include "data_process.h"
double inductance_data_max[5]={1,1,1,1,1};


extern a data;
extern b speed_data;
extern c angle_data;

extern e up_pid;
extern e speed_pid;
extern e direction_pid;
extern e current_pid;

extern float balance_angle_value;//小车处于平衡位置的俯仰角（用按键去修改）

float temp1 = 0;

float complementary_coefficient=0.9;//互补滤波系数
//-------------------------------------------------------------------------------------------------------------------
// @brief		??????????
// @param		ch				???ADC???
// @param		resolution		??????????????(????????????????????????????? ???????????????????Ч)
// @return		void
// Sample usage:				adc_init(ADC_1, ADC1_CH00_A00, ADC_8BIT);						//?????A00?ADC???? ??????8λ
//-------------------------------------------------------------------------------------------------------------------
void AngularSpeedAngleCalculate(){
//  if((angle_data.angular_speed_y_data<5)&&(angle_data.angular_speed_y_data>-5))//去皮
//  angle_data.angular_speed_y_data = 0;//减去零点角速度偏差
//  angle_data.angularspeed_angle_value=angle_data.angularspeed_angle_value+angle_data.angular_speed_y_data*change_angle_coefficient;
////angle_data.angularspeed_angle_value=angle_data.angularspeed_angle_value+angle_data.angular_speed_y_data;
  
//    if((angle_data.angular_speed_y_data<1)&&(angle_data.angular_speed_y_data>-1))//去皮
//  angle_data.angular_speed_y_data = 0;//减去零点角速度偏差
  angle_data.angularspeed_angle_value=angle_data.angularspeed_angle_value+angle_data.angular_speed_y_data;
  temp1=angle_data.angularspeed_angle_value;
}


//-------------------------------------------------------------------------------------------------------------------
// @brief		???????(????)
// @param		ch				???ADC???
// @param		resolution		??????????????(????????????????????????????? ???????????????????Ч)
// @return		void
// Sample usage:				adc_init(ADC_1, ADC1_CH00_A00, ADC_8BIT);						//?????A00?ADC???? ??????8λ
//-------------------------------------------------------------------------------------------------------------------
void FuseAngleCalculate(){

//angle_data.angularspeed_angle_value=angle_data.angularspeed_angle_value+(angle_data.accelerate_angle_value-angle_data.angularspeed_angle_value-93.9)*complementary_coefficient;//???????????????????
//angle_data.fuse_angle_value=angle_data.angularspeed_angle_value+94;//????????????????????????
//angle_data.fuse_angle_pid_value=angle_data.fuse_angle_value-balance_angle_value;//??????λ??????0//????pid????
  
//  temp1=temp1+(angle_data.accelerate_angle_value-temp1)*complementary_coefficient;//这样写应该是有问题的，因为角速度的初始值从0开始就会很慢
//angle_data.fuse_angle_value=temp1;//????????????????????????
//angle_data.fuse_angle_pid_value=angle_data.fuse_angle_value-balance_angle_value;//??????λ??????0//????pid????
  
    angle_data.angularspeed_angle_value=angle_data.angularspeed_angle_value+(angle_data.accelerate_angle_value-angle_data.angularspeed_angle_value)*complementary_coefficient;//???????????????????
angle_data.fuse_angle_value=angle_data.angularspeed_angle_value;//????????????????????????
angle_data.fuse_angle_pid_value=angle_data.fuse_angle_value-balance_angle_value;//??????λ??????0//????pid???

}




//-------------------------------------------------------------------------------------------------------------------
// @brief		ADC
// @param		ch				???ADC???
// @param		resolution		??????????????(????????????????????????????? ???????????????????Ч)
// @return		void
// Sample usage:				adc_init(ADC_1, ADC1_CH00_A00, ADC_8BIT);						//?????A00?ADC???? ??????8λ
//-------------------------------------------------------------------------------------------------------------------
void ADCFilterProcess()
{
  MedianAverageFilter();//??λ???????
//  TimeWeightFilter();//?????????

}



//-------------------------------------------------------------------------------------------------------------------
// @brief		????????????????????????????????????????????????????????????????
// @param		ch				???ADC???
// @param		resolution		??????????????(????????????????????????????? ???????????????????Ч)
// @return		void
// Sample usage:				adc_init(ADC_1, ADC1_CH00_A00, ADC_8BIT);						//?????A00?ADC???? ??????8λ
//-------------------------------------------------------------------------------------------------------------------
void InductanceProcess(){
  uint16 i=0;
  for(;i<inductance_num;i++)
  {
     data.inductance_normalization[i]=data.filter_inductance_data[i]/inductance_data_max[i];//??????/(???????-?????С?)
     if(data.inductance_normalization[i]<=0.001)
     {
      data.inductance_normalization[i]=0.001;
     }
  }
}

//-------------------------------------------------------------------------------------------------------------------
// @brief		????(??????????????)
// @param		ch				???ADC???
// @param		resolution		??????????????(????????????????????????????? ???????????????????Ч)
// @return		void
// Sample usage:				adc_init(ADC_1, ADC1_CH00_A00, ADC_8BIT);						//?????A00?ADC???? ??????8λ
//-------------------------------------------------------------------------------------------------------------------
float DirectionErrorOutput1()
{
  float DirectionErrorOutput=
  ((data.inductance_normalization[0]-data.inductance_normalization[2])/(data.inductance_normalization[0]+data.inductance_normalization[2])+data.inductance_normalization[1])/2;//???????????
      return DirectionErrorOutput;
}

//-------------------------------------------------------------------------------------------------------------------
// @brief		?????(??????????????)
// @param		ch				???ADC???
// @param		resolution		??????????????(????????????????????????????? ???????????????????Ч)
// @return		void
// Sample usage:				adc_init(ADC_1, ADC1_CH00_A00, ADC_8BIT);						//?????A00?ADC???? ??????8λ
//-------------------------------------------------------------------------------------------------------------------
float DirectionErrorOutput2()
{
    float DirectionErrorOutput=
    FastAbs((FastSqrt(data.inductance_normalization[0])-FastSqrt(data.inductance_normalization[4]))/(data.inductance_normalization[0]+data.inductance_normalization[2]));
    data.position_error=DirectionErrorOutput;
    return DirectionErrorOutput;
}

//-------------------------------------------------------------------------------------------------------------------
// @brief		?????(??????????????)
// @param		ch				???ADC???
// @param		resolution		??????????????(????????????????????????????? ???????????????????Ч)
// @return		void
// Sample usage:				adc_init(ADC_1, ADC1_CH00_A00, ADC_8BIT);						//?????A00?ADC???? ??????8λ
//-------------------------------------------------------------------------------------------------------------------
void DirectionErrorOutput3()
{
//  direction_pid.actual_value=
    //?????????????н?????????
      
}

//-------------------------------------------------------------------------------------------------------------------
// @brief		?????????
// @param		ch				???ADC???
// @param		resolution		??????????????(????????????????????????????? ???????????????????Ч)
// @return		void
// Sample usage:				adc_init(ADC_1, ADC1_CH00_A00, ADC_8BIT);						//?????A00?ADC???? ??????8λ
//-------------------------------------------------------------------------------------------------------------------
void TotalDataProcess()
{
  AngularSpeedAngleCalculate();
  FuseAngleCalculate();
  ADCFilterProcess();
  InductanceProcess();
  DirectionErrorOutput1();//????
//  DirectionErrorOutput2();//?????
}